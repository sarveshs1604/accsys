<main id="main" class="main" style="margin-left: 300px; max-width: 75%;">
    <div class="container">
        <div class="pagetitle d-flex align-items-center justify-content-between">
            <h1 class="card-title">Form Details/ {{ form.doc_number }}</h1>

            <a href="{% url 'form_list' %}" class="btn btn-secondary">Back to List</a>
        </div>
    </div>


    <section class="section">
        <div class="card">
            <div class="card-body pt-3">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-bordered">
                            <tr><th>Document Number</th><td>{{ form.doc_number }}</td></tr>
                            <tr><th>Invoice Value</th><td>{{ form.invoice_value|floatformat:2 }}</td></tr>
                            <tr><th>Taxable Value</th><td>{{ form.taxable_value|floatformat:2 }}</td></tr>
                            <tr><th>IGST Value</th><td>{{ form.igst_value|default_if_none:"N/A" }}</td></tr>
                            <tr><th>CGST Value</th><td>{{ form.cgst_value|default_if_none:"N/A" }}</td></tr>
                            <tr><th>SGST Value</th><td>{{ form.sgst_value|default_if_none:"N/A" }}</td></tr>
                            <tr><th>Vendor Name</th><td>{{ form.vendor_name }}</td></tr>
                            <tr><th>Reference Number</th><td>{{ form.reference_number }}</td></tr>
                            <tr><th>Profit Center</th><td>{{ form.profit_center|default_if_none:"-" }}</td></tr>
                            <tr><th>Created At</th><td>{{ form.created_at|date:"d M Y, H:i A" }}</td></tr>
                        </table>
                    </div>

                    <div class="col-md-6">
                        <table class="table table-bordered">
                            <tr><th>Assignee</th><td>{{ form.assignees.all|default_if_none:"-" }}</td></tr>
                            <tr><th>Status</th>
                            <td> {% if request.user == form.assignees.all %}
                                <form method="post">
                                    {% csrf_token %}
                                    <select name="status" class="form-control">
                                        <option value="In Progress" {% if form.status == "In Progress" %} selected {% endif %}>In Progress</option>
                                        <option value="Raise Query" {% if form.status == "Raise Query" %} selected {% endif %}>Raise Query</option>
                                        <option value="Closed" {% if form.status == "Closed" %} selected {% endif %}>Closed</option>
                                    
                                    </select>
                                    <button type="submit" class="btn btn-success btn-sm mt-2">Update Status</button>
                                </form>
                                {% else %}
                                <input type="text" value="{{ form.status }}" class="form-control" readonly>
                                {% endif %}</td>
                            </tr>
                            {% if form.documents %}
                            <tr>
                                <th>Document</th>
                                <td>
                                    <a href="{{ form.documents.url }}" target="_blank" class="btn btn-primary btn-sm">
                                        Document
                                    </a>
                                </td>
                            </tr>
                            {% endif %}
                        </table>
                    </div>
                </div>

                <div class="text-center">
                {% if request.user == form.created_by %}  
                    <button id="edit-btn" class="btn btn-primary">Edit</button>  
                {% endif %}
                </div>
            </div>
        </div>
        
    </section>
    {% if form.updated_fields %}
        <h3 class="mt-4">Updated Fields</h3>
        <table class="table table-bordered">
            {% for field, value in form.updated_fields.items %}
            <tr>
                <th>{{ field }}</th>
                <td>{{ value }}</td>
            </tr>
            {% endfor %}
        </table>
    {% endif %}
    <form id="edit-form" method="POST" action="{% url 'update_form' form.id %}" style="display: none;">
        {% csrf_token %}
        <table class="table table-bordered">
            <tr>
                <th>Vendor Name</th>
                <td><input type="text" name="vendor_name" value="{{ form.vendor_name }}" class="form-control"></td>
            </tr>
            <tr>
                <th>Reference Number</th>
                <td><input type="text" name="reference_number" value="{{ form.reference_number }}" class="form-control"></td>
            </tr>
            <tr>
                <th>Profit Center</th>
                <td><input type="text" name="profit_center" value="{{ form.profit_center }}" class="form-control"></td>
            </tr>
            <tr>
                <th>Invoice Value</th>
                <td><input type="text" name="invoice_value" value="{{ form.invoice_value }}" class="form-control"></td>
            </tr>
        </table>
        <button type="submit" class="btn btn-success">Save Changes</button>
    </form>
</main>

# @login_required
# def update_form(request, form_id):
#     form = get_object_or_404(BookingForm, id=form_id)

#     if request.method == "POST":
#         updated_fields = {}

#         vendor_name   = request.POST.get("vendor_name")
#         profit_center = request.POST.get("profit_center")
#         invoice_value = request.POST.get("invoice_value")
#         taxable_value = request.POST.get("taxable_value")
#         igst_value    = request.POST.get("igst_value")
#         cgst_value    = request.POST.get("cgst_value")
#         sgst_value    = request.POST.get("sgst_value")
#         # Retrieve file from FILES if provided
#         document_file = request.FILES.get("document")

#         if vendor_name and form.vendor_name != vendor_name:
#             updated_fields["Vendor Name"] = vendor_name
#             form.vendor_name = vendor_name

#         if profit_center and form.profit_center != profit_center:
#             updated_fields["Profit Center"] = profit_center
#             form.profit_center = profit_center

#         if invoice_value and str(form.invoice_value) != invoice_value:
#             updated_fields["Invoice Value"] = invoice_value
#             form.invoice_value = invoice_value

#         if taxable_value and str(form.taxable_value) != taxable_value:
#             updated_fields["Taxable Value"] = taxable_value
#             form.taxable_value = taxable_value

#         if igst_value and str(form.igst_value) != igst_value:
#             updated_fields["IGST Value"] = igst_value
#             form.igst_value = igst_value

#         if cgst_value and str(form.cgst_value) != cgst_value:
#             updated_fields["CGST Value"] = cgst_value
#             form.cgst_value = cgst_value

#         if sgst_value and str(form.sgst_value) != sgst_value:
#             updated_fields["SGST Value"] = sgst_value
#             form.sgst_value = sgst_value

#         # Update document if a new file is provided
#         if document_file:
#             updated_fields["Document"] = document_file.name
#             form.document = document_file
        
#         # Compare old and new values, only store changes
#         # if form.vendor_name != request.POST["vendor_name"]:
#         #     updated_fields["Vendor Name"] = request.POST["vendor_name"]
#         #     form.vendor_name = request.POST["vendor_name"]

#         # if form.invoice_value != request.POST["invoice_value"]:
#         #     updated_fields["invoice_value"] = request.POST["invoice_value"]
#         #     form.invoice_value = request.POST["invoice_value"]

#         # Save changes
#         form.updated_fields = updated_fields  # Store updated values
#         form.save()

#         messages.success(request, "Form updated successfully!")
#         return redirect("form_detail", form_id=form.id)
    
#     return redirect("form_detail", form_id=form.id)

                    <!-- Existing details code here -->

                    <!-- <div class="d-flex justify-content-center">
                        <div class="btn-group w-25" role="group" aria-label="Edit and History">
                            {% if request.user == form.created_by %}
                                <button id="edit-btn" type="button" class="btn btn-primary">Edit</button>
                            {% else %}
                                <button id="edit-btn" type="button" class="btn btn-primary" disabled>Edit</button>
                            {% endif %}
                            <button id="history-btn" type="button" class="btn btn-info">History</button>
                        </div>
                    </div>

                <div class="collapsed" id="history-section">
                    <h3>Update History</h3>
                    {% if form.updates.all %}
                        <ul class="list-group">
                            {% for log in form.updates.all %}
                                <li class="list-group-item">
                                    <strong>{{ log.field_name }}:</strong> {{ log.old_value }} &rarr; {{ log.new_value }}<br>
                                    <small class="text-muted">
                                        Updated by: {{ log.updated_by.username }},
                                    </small><br>
                                    <small class="text-muted">
                                        Updated at: {{ log.updated_at|date:"d M Y, H:i A" }}
                                    </small>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted">No updates have been made yet.</p>
                    {% endif %}
                </div>
 
     
                 
                 <form id="edit-form" method="POST" action="{% url 'update_form' form.id %}" enctype="multipart/form-data" class="collapsed">
                    {% csrf_token %}
                    <div class="row">
             
                        <div class="col-md-4">
                            <label for="vendor_name" class="form-label">Vendor Name</label>
                            <input type="text" id="vendor_name" name="vendor_name" value="{{ form.vendor_name }}" class="form-control">
                        </div>
                
                      
                        <div class="col-md-4">
                            <label for="profit_center" class="form-label">Profit Center</label>
                            <input type="text" id="profit_center" name="profit_center" value="{{ form.profit_center }}" class="form-control">
                        </div>
                
             
                        <div class="col-md-4">
                            <label for="invoice_value" class="form-label">Invoice Value</label>
                            <input type="text" id="invoice_value" name="invoice_value" value="{{ form.invoice_value }}" class="form-control">
                        </div>
                    </div>
                
                    <div class="row mt-3">
          
                        <div class="col-md-4">
                            <label for="taxable_value" class="form-label">Taxable Value</label>
                            <input type="text" id="taxable_value" name="taxable_value" value="{{ form.taxable_value }}" class="form-control">
                        </div>
                
            
                        <div class="col-md-4">
                            <label for="igst_value" class="form-label">IGST Value</label>
                            <input type="text" id="igst_value" name="igst_value" value="{{ form.igst_value }}" class="form-control">
                        </div>
                
              
                        <div class="col-md-4">
                            <label for="cgst_value" class="form-label">CGST Value</label>
                            <input type="text" id="cgst_value" name="cgst_value" value="{{ form.cgst_value }}" class="form-control">
                        </div>
                    </div>
                
                    <div class="row mt-3">
      
                        <div class="col-md-4">
                            <label for="sgst_value" class="form-label">SGST Value</label>
                            <input type="text" id="sgst_value" name="sgst_value" value="{{ form.sgst_value }}" class="form-control">
                        </div>
                

                        <div class="col-md-4">
                            <label for="document" class="form-label">Document</label>
                            <input type="file" id="document" name="document" class="form-control">
                        </div>

                        <div class="col-md-4">
                            <label for="reference_number" class="form-label">reference number</label>
                            <input type="text" id="reference_number" name="reference_number" value="{{ form.reference_number }}" class="form-control">
                        </div>
                

                        
                    </div>
                    <br>
                    <div class="text-center">
                        <button type="submit" class="btn btn-success">Save Changes</button>
                    </div>
                </form> -->

                <td>
                    <a href="#" data-bs-toggle="modal" data-bs-target="#assigneesModal{{ form.id }}">View Assignees</a>
                    
                    <!-- Bootstrap Modal for Assignees -->
                    <div class="modal fade" id="assigneesModal{{ form.id }}" tabindex="-1" aria-labelledby="assigneesModalLabel{{ form.id }}" aria-hidden="true">
                      <div class="modal-dialog">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title" id="assigneesModalLabel{{ form.id }}">Assignees for {{ form.doc_number }}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>
                          <div class="modal-body">
                            <ul class="list-group">
                              {% for assignee in form.assignees.all %}
                                  <li class="list-group-item">{{ assignee.username }}</li>
                              {% empty %}
                                  <li class="list-group-item">No assignees assigned.</li>
                              {% endfor %}
                            </ul>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                          </div>
                        </div>
                      </div>
                    </div>
                </td>

                # class QueryLog(models.Model):
                #     form = models.ForeignKey('BookingForm', on_delete=models.CASCADE, related_name="query_logs")
                #     query_comment = models.TextField()  # Comment raised by the assignee
                #     resolve_comment = models.TextField(blank=True, null=True)  # Comment from the client when resolving
                #     update_details = models.TextField(blank=True, null=True)  # Details of updates made during resolution
                #     updated_by = models.ForeignKey(User, on_delete=models.SET_NULL, null=True)
                #     created_at = models.DateTimeField(auto_now_add=True)
                
                #     def __str__(self):
                #         return f"Query on {self.form.doc_number} at {self.created_at.strftime('%Y-%m-%d %H:%M:%S')}"

                <main id="main" class="main" style="margin-left: 300px; max-width: 75%;">
                    <div class="container">
                      <div class="pagetitle d-flex align-items-center justify-content-between">
                        <h1 class="card-title">Form Details / {{ form.doc_number }}</h1>
                        <a href="{% url 'form_list' %}" class="btn btn-secondary">Back to List</a>
                      </div>
                    </div>
                  
                    <section class="section">
                      <div class="card">
                        <div class="card-body pt-3">
                          <!-- Read-Only Details Section -->
                          <div class="row" id="read-only-section">
                            <!-- Left Column -->
                            <div class="col-md-6">
                              <table class="table table-bordered">
                                <tr>
                                  <th>Document Number</th>
                                  <td>{{ form.doc_number }}</td>
                                </tr>
                                <tr>
                                  <th>Invoice Value</th>
                                  <td>{{ form.invoice_value|floatformat:2 }}</td>
                                </tr>
                                <tr>
                                  <th>Taxable Value</th>
                                  <td>{{ form.taxable_value|floatformat:2 }}</td>
                                </tr>
                                <tr>
                                  <th>IGST Value</th>
                                  <td>{{ form.igst_value|default_if_none:"N/A" }}</td>
                                </tr>
                                <tr>
                                  <th>CGST Value</th>
                                  <td>{{ form.cgst_value|default_if_none:"N/A" }}</td>
                                </tr>
                                <tr>
                                  <th>SGST Value</th>
                                  <td>{{ form.sgst_value|default_if_none:"N/A" }}</td>
                                </tr>
                                <tr>
                                  <th>Vendor Name</th>
                                  <td>{{ form.vendor_name }}</td>
                                </tr>
                                <tr>
                                  <th>Reference Number</th>
                                  <td>{{ form.reference_number }}</td>
                                </tr>
                                <tr>
                                  <th>Profit Center</th>
                                  <td>{{ form.profit_center|default_if_none:"-" }}</td>
                                </tr>
                                <tr>
                                  <th>Created At</th>
                                  <td>{{ form.created_at|date:"d M Y, H:i A" }}</td>
                                </tr>
                              </table>
                            </div>
                  
                            <!-- Right Column -->
                            <div class="col-md-6">
                              <table class="table table-bordered">
                                <tr>
                                  <th>Assignee</th>
                                  <td>
                                    {% for assignee in form.assignees.all %}
                                        {{ assignee.username }}{% if not forloop.last %}, {% endif %}
                                    {% empty %}
                                        -
                                    {% endfor %}
                                </td>
                                </tr>
                                <tr>
                                  <th>Status</th>
                                  <td>
                                    {% if request.user in form.assignees.all %}
                                      <form method="post">
                                        {% csrf_token %}
                                        <select name="status" class="form-control">
                                          <option value="In Progress" {% if form.status == "In Progress" %} selected {% endif %}>In Progress</option>
                                          <option value="Raise Query" {% if form.status == "Raise Query" %} selected {% endif %}>Raise Query</option>
                                          <option value="Closed" {% if form.status == "Closed" %} selected {% endif %}>Closed</option>
                                        </select>
                                        <button type="submit" class="btn btn-success btn-sm mt-2">Update Status</button>
                                      </form>
                                    {% else %}
                                      <input type="text" value="{{ form.status }}" class="form-control" readonly>
                                    {% endif %}
                                  </td>
                                </tr>
                                {% if form.documents %}
                                <tr>
                                  <th>Document</th>
                                  <td>
                                    {% if documents %}
                                        <ul>
                                            {% for document in documents %}
                                                <li>
                                                    <a href="{{ document.file.url }}" target="_blank" title="{{ document.file.name|cut:'documents/' }}">
                                                        {% with document.file.name|cut:"documents/" as file_name %}
                                                            {% if file_name|length > 30 %}
                                                                {{ file_name|slice:":30" }}...
                                                            {% else %}
                                                                {{ file_name }}
                                                            {% endif %}
                                                        {% endwith %}
                                                    </a>                              
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        <p>No documents uploaded.</p>
                                    {% endif %}
                                </td>
                                </tr>
                                {% endif %}
                              </table>
                            </div>
                          </div>
                  
                          <!-- Button Group: Edit & History -->
                          <div aria-label="Edit and History">
                            {% if request.user == form.created_by %}
                              <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#editFormCollapse" aria-expanded="false" aria-controls="editFormCollapse">
                                Edit
                              </button>
                            {% elif request.user in form.assignees.all and form.status == "In Progress" %}
                              <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#referenceCollapse" aria-expanded="false" aria-controls="referenceCollapse">
                                Add Reference
                              </button>
                            {% else %}
                              <button class="btn btn-primary" type="button" disabled>
                                Edit
                              </button>
                            {% endif %}
                            <button class="btn btn-info" type="button" data-bs-toggle="collapse" data-bs-target="#historyCollapse" aria-expanded="false" aria-controls="historyCollapse">
                              History
                            </button>
                          </div>
                          <p>
                          <!-- Collapsible Edit Form -->
                          <div class="collapse" id="editFormCollapse">
                            <div class="card card-body">
                              <form method="POST" action="{% url 'update_form' form.id %}" enctype="multipart/form-data">
                                {% csrf_token %}
                                <div class="row">
                                  <div class="col-md-4">
                                    <label for="vendor_name" class="form-label">Vendor Name</label>
                                    <input type="text" id="vendor_name" name="vendor_name" value="{{ form.vendor_name }}" class="form-control">
                                  </div>
                                  <div class="col-md-4">
                                    <label for="profit_center" class="form-label">Profit Center</label>
                                    <input type="text" id="profit_center" name="profit_center" value="{{ form.profit_center }}" class="form-control">
                                  </div>
                                  <div class="col-md-4">
                                    <label for="invoice_value" class="form-label">Invoice Value</label>
                                    <input type="text" id="invoice_value" name="invoice_value" value="{{ form.invoice_value }}" class="form-control">
                                  </div>
                                </div>
                                <div class="row mt-3">
                                  <div class="col-md-4">
                                    <label for="taxable_value" class="form-label">Taxable Value</label>
                                    <input type="text" id="taxable_value" name="taxable_value" value="{{ form.taxable_value }}" class="form-control">
                                  </div>
                                  <div class="col-md-4">
                                    <label for="igst_value" class="form-label">IGST Value</label>
                                    <input type="text" id="igst_value" name="igst_value" value="{{ form.igst_value }}" class="form-control">
                                  </div>
                                  <div class="col-md-4">
                                    <label for="cgst_value" class="form-label">CGST Value</label>
                                    <input type="text" id="cgst_value" name="cgst_value" value="{{ form.cgst_value }}" class="form-control">
                                  </div>
                                </div>
                                <div class="row mt-3">
                                  <div class="col-md-4">
                                    <label for="sgst_value" class="form-label">SGST Value</label>
                                    <input type="text" id="sgst_value" name="sgst_value" value="{{ form.sgst_value }}" class="form-control">
                                  </div>
                                  <div class="col-md-4">
                                    <label for="documents" class="form-label">Document</label>
                                    <input type="file" name="documents" id="documents" class="form-control" multiple>
                                  </div>
                                  <br>
                                  <div class="col-md-4 d-flex align-items-end">
                                      <button type="submit" class="btn btn-success w-100">Save Changes</button>
                                  </div>
                                  
                                </div>
                                
                              </form>
                            </div>
                          </div>
                  
                          <div class="collapse mt-3" id="referenceCollapse">
                            <div class="card card-body">
                                <h5 class="card-title">Enter Reference Number</h5>
                                <form method="POST" action="{% url 'add_reference' form.id %}">
                                    {% csrf_token %}
                                    <div class="mb-3">
                                        <label for="referenceNumber" class="form-label">Reference Number:</label>
                                        <input type="text" name="reference_number" id="referenceNumber" class="form-control" value="{{ form.reference_number }}" required>
                                    </div>
                                    <button type="submit" class="btn btn-success">Submit</button>
                                </form>
                            </div>
                        </div>
                        
                  
                          <!-- Collapsible History Section -->
                          <div class="collapse" id="historyCollapse">
                            <div class="card card-body">
                              <h3>Update History</h3>
                              {% if form.updates.all %}
                                <ul class="list-group">
                                  {% for log in form.updates.all %}
                                    <li class="list-group-item">
                                      <strong>{{ log.field_name }}:</strong> {{ log.old_value|cut:"documents/" }} &rarr; {{ log.new_value }}<br>
                                      <small class="text-muted">
                                        Updated by: {{ log.updated_by.username }},
                                      </small><br>
                                      <small class="text-muted">
                                        Updated at: {{ log.updated_at|date:"d M Y, H:i A" }}
                                      </small>
                                    </li>
                                  {% endfor %}
                                </ul>
                              {% else %}
                                <p class="text-muted">No updates have been made yet.</p>
                              {% endif %}
                            </div>
                          </div>
                          </p>    
                          </div>
                          <div>
                            <button class="btn btn-primary mt-3" type="button" data-bs-toggle="collapse" data-bs-target="#queryHistory">
                              Show Query History
                          </button>
                          
                          <div class="collapse mt-3" id="queryHistory">
                            <div class="card card-body">
                                <h5>Query History</h5>
                                {% for query in form.query_logs.all %}
                                    <div class="border p-2 mb-2">
                                        <p><strong>Query by:</strong> {{ query.assignee }}</p>
                                        <p><strong>Query Comment:</strong> {{ query.query_comment }}</p>
                                        <p><strong>Updated Fields:</strong></p>
                                        <ul>
                                            {% for field, change in query.updated_fields.items %}
                                                <li>{{ field }}: {{ change }}</li>
                                            {% endfor %}
                                        </ul>
                                        <p><strong>Resolution Comment:</strong> {{ query.resolution_comment }}</p>
                                        <p><small>Resolved by {{ query.updated_by }} on {{ query.resolved_at }}</small></p>
                                    </div>
                                {% empty %}
                                    <p>No query history available.</p>
                                {% endfor %}
                            </div>
                        </div>
                          
                            
                          </div>
                          <div>
                          {% if request.user in form.assignees.all and form.status == "Raise Query" %}
                          <button class="btn btn-primary mt-3" type="button" data-bs-toggle="collapse" data-bs-target="#queryCollapse" aria-expanded="false" aria-controls="queryCollapse">
                            Add Query Comment
                          </button>
                          <div class="collapse mt-3" id="queryCollapse">
                            <div class="card card-body">
                              <form method="post" action="{% url 'add_query' form.id %}">
                                {% csrf_token %}
                                <div class="mb-3">
                                  <label for="queryComment" class="form-label">Query Comment:</label>
                                  <textarea id="queryComment" name="query_comment" class="form-control" rows="3" required></textarea>
                                </div>
                                <button type="submit" class="btn btn-success">Submit Query</button>
                              </form>
                            </div>
                          </div>
                        {% endif %}
                        </div>
                        {% if show_resolve_button %}
                            {% if form.status == "Raise Query" and request.user.id == form.created_by.id %}
                            <button class="btn btn-warning mt-3" type="button" data-bs-toggle="collapse" data-bs-target="#resolveQueryCollapse" aria-expanded="false" aria-controls="resolveQueryCollapse">
                              Resolve Query
                            </button>
                            {% endif %}
                  
                            <div class="collapse mt-3" id="resolveQueryForm">
                                <form method="POST" action="{% url 'resolve_query' form.id %}">
                                    {% csrf_token %}
                                    <div class="card card-body">
                                        <h5>Query from Assignee:</h5>
                                        <p>{{ latest_query.query_comment }}</p>
                  
                                        <h5>Edit Fields:</h5>
                                        <label for="vendor_name" class="form-label">Vendor Name</label>
                                        <input type="text" name="vendor_name" class="form-control mb-2" value="{{ form.vendor_name }}" placeholder="Vendor Name">
                                        
                                        <label for="profit_center" class="form-label">Profit Center</label>
                                        <input type="text" name="profit_center" class="form-control mb-2" value="{{ form.profit_center }}" placeholder="Profit Center">
                                        
                                        <label for="reference_number" class="form-label">Reference Number</label>
                                        <input type="text" name="reference_number" class="form-control mb-2" value="{{ form.reference_number }}" placeholder="Reference Number">
                  
                                        <label for="invoice_value" class="form-label">Invoice Value</label>
                                        <input type="number" step="0.01" name="invoice_value" class="form-control mb-2" value="{{ form.invoice_value }}" placeholder="Invoice Value">
                  
                                        <label for="taxable_value" class="form-label">Taxable Value</label>
                                        <input type="number" step="0.01" name="taxable_value" class="form-control mb-2" value="{{ form.taxable_value }}" placeholder="Taxable Value">
                  
                                        <label for="igst_value" class="form-label">IGST Value</label>
                                        <input type="number" step="0.01" name="igst_value" class="form-control mb-2" value="{{ form.igst_value }}" placeholder="IGST Value">
                  
                                        <label for="cgst_value" class="form-label">CGST Value</label>
                                        <input type="number" step="0.01" name="cgst_value" class="form-control mb-2" value="{{ form.cgst_value }}" placeholder="CGST Value">
                  
                                        <label for="sgst_value" class="form-label">SGST Value</label>
                                        <input type="number" step="0.01" name="sgst_value" class="form-control mb-2" value="{{ form.sgst_value }}" placeholder="SGST Value">
                  
                                        <!-- File Upload -->
                                        <label for="documents" class="form-label">Upload New Documents</label>
                                        <input type="file" name="documents" class="form-control mb-2" multiple>
                  
                                        <h5>Resolution Comment:</h5>
                                        <textarea name="resolution_comment" class="form-control mb-2" placeholder="Enter your resolution comment"></textarea>
                  
                                        <button type="submit" class="btn btn-success">Submit Resolution</button>
                                    </div>
                                </form>
                            </div>
                        {% endif %}
                  
                      
                  
                  
                  
                        </div>
                      </div>
                    </section>
                  </main>



the forrm details page
                  <section class="section">
                    <div class="card">
                      <div class="card-body pt-3">
                        <!-- Read-Only Details Section -->
                        <div class="row" id="read-only-section">
                          <!-- Left Column -->
                          <div class="col-md-6">
                            <table class="table table-bordered">
                              <tr>
                                <th>Document Number</th>
                                <td>{{ form.doc_number }}</td>
                              </tr>
                              <tr>
                                <th>Invoice Value</th>
                                <td>{{ form.invoice_value|floatformat:2 }}</td>
                              </tr>
                              <tr>
                                <th>Taxable Value</th>
                                <td>{{ form.taxable_value|floatformat:2 }}</td>
                              </tr>
                              <tr>
                                <th>IGST Value</th>
                                <td>{{ form.igst_value|default_if_none:"N/A" }}</td>
                              </tr>
                              <tr>
                                <th>CGST Value</th>
                                <td>{{ form.cgst_value|default_if_none:"N/A" }}</td>
                              </tr>
                              <tr>
                                <th>SGST Value</th>
                                <td>{{ form.sgst_value|default_if_none:"N/A" }}</td>
                              </tr>
                              <tr>
                                <th>Vendor Name</th>
                                <td>{{ form.vendor_name }}</td>
                              </tr>
                              <tr>
                                <th>Reference Number</th>
                                <td>{{ form.reference_number }}</td>
                              </tr>
                              <tr>
                                <th>Profit Center</th>
                                <td>{{ form.profit_center|default_if_none:"-" }}</td>
                              </tr>
                              <tr>
                                <th>Created At</th>
                                <td>{{ form.created_at|date:"d M Y, H:i A" }}</td>
                              </tr>
                            </table>
                          </div>
                
                          <!-- Right Column -->
                          <div class="col-md-6">
                            <table class="table table-bordered">
                              <tr>
                                <th>Assignee</th>
                                <td>
                                  {% for assignee in form.assignees.all %}
                                      {{ assignee.username }}{% if not forloop.last %}, {% endif %}
                                  {% empty %}
                                      -
                                  {% endfor %}
                              </td>
                              </tr>
                              <tr>
                                <th>Status</th>
                                <td>
                                  {% if request.user in form.assignees.all %}
                                    <form method="post">
                                      {% csrf_token %}
                                      <select name="status" class="form-control">
                                        <option value="In Progress" {% if form.status == "In Progress" %} selected {% endif %}>In Progress</option>
                                        <option value="Raise Query" {% if form.status == "Raise Query" %} selected {% endif %}>Raise Query</option>
                                        <option value="Closed" {% if form.status == "Closed" %} selected {% endif %}>Closed</option>
                                      </select>
                                      <button type="submit" class="btn btn-success btn-sm mt-2">Update Status</button>
                                    </form>
                                  {% else %}
                                    <input type="text" value="{{ form.status }}" class="form-control" readonly>
                                  {% endif %}
                                </td>
                              </tr>
                              {% if form.documents %}
                              <tr>
                                <th>Document</th>
                                <td>
                                  {% if documents %}
                                      <ul>
                                          {% for document in documents %}
                                              <li>
                                                  <a href="{{ document.file.url }}" target="_blank" title="{{ document.file.name|cut:'documents/' }}">
                                                      {% with document.file.name|cut:"documents/" as file_name %}
                                                          {% if file_name|length > 30 %}
                                                              {{ file_name|slice:":30" }}...
                                                          {% else %}
                                                              {{ file_name }}
                                                          {% endif %}
                                                      {% endwith %}
                                                  </a>                              
                                              </li>
                                          {% endfor %}
                                      </ul>
                                  {% else %}
                                      <p>No documents uploaded.</p>
                                  {% endif %}
                              </td>
                              </tr>
                              {% endif %}
                            </table>
                          </div>
                        </div>
                  </section>

                  masterssss
                  {% extends 'main.html' %}
{% block content %}
<main id="main" class="main" style="margin-left: 300px; max-width: 75%;">
<div class="container mt-3">
  <h1>Masters</h1>
  <a href="{% url 'form_list' %}" class="btn btn-secondary">Back</a>
  <ul class="nav nav-tabs" id="mastersTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="mapping-tab" data-bs-toggle="tab" data-bs-target="#mapping" type="button" role="tab">
        Client-Assignee Mapping
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="doc-types-tab" data-bs-toggle="tab" data-bs-target="#doc-types" type="button" role="tab">
        Document Types
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab3-tab" data-bs-toggle="tab" data-bs-target="#tab3" type="button" role="tab">
        Tab 3
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab4-tab" data-bs-toggle="tab" data-bs-target="#tab4" type="button" role="tab">
        Tab 4
      </button>
    </li>
  </ul>
  <div class="tab-content" id="mastersTabContent">
    <!-- Tab 1: Client-Assignee Mapping -->
    <div class="tab-pane fade show active" id="mapping" role="tabpanel">
      <h3 class="mt-3">Client-Assignee Mapping</h3>
      <form method="POST" action="{% url 'save_mapping' %}">
        {% csrf_token %}
        <div class="mb-3">
          <label for="client" class="form-label">Select Client:</label>
          <select id="client" name="client" class="form-control" required>
            <option value="">-- Select Client --</option>
            {% for client in clients %}
              <option value="{{ client.id }}">{{ client.username }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-3" id="assignee-container" style="display: none;">
          <label for="assignee-select" class="form-label">Select Assignees:</label>
          <select id="assignee-select" name="assignees" class="form-control" multiple required>
            {% for user in clients %}
              <option value="{{ user.id }}">{{ user.username }}</option>
            {% endfor %}
          </select>
        </div>
        <button type="submit" class="btn btn-primary">Save Mapping</button>
      </form>
    </div>

    <!-- Tab 2: Document Types Management -->
<div class="tab-pane fade" id="doc-types" role="tabpanel">
  <h3 class="mt-3">Document Types</h3>
  <form method="POST" action="{% url 'save_document_type' %}">
    {% csrf_token %}
    <div class="mb-3">
      <label for="doc-type-name" class="form-label">Document Type Name</label>
      <input type="text" name="name" id="doc-type-name" class="form-control" required>
    </div>
    <div class="mb-3">
      <label for="doc-type-desc" class="form-label">Description</label>
      <textarea name="description" id="doc-type-desc" class="form-control"></textarea>
    </div>
    <button type="submit" class="btn btn-primary">Save Document Type</button>
  </form>
  <h4 class="mt-3">Existing Document Types</h4>
  <ul class="list-group">
    {% for dt in document_types %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span>{{ dt.name }} - {{ dt.description }}</span>
        <a href="{% url 'delete_document_type' dt.id %}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this document type?');">
          Delete
        </a>
      </li>
    {% empty %}
      <li class="list-group-item">No document types available.</li>
    {% endfor %}
  </ul>
</div>

    
    <!-- Tab 2: Document Types Management -->
    <!-- <div class="tab-pane fade" id="doc-types" role="tabpanel">
      <h3 class="mt-3">Document Types</h3>
      <form method="POST" action="{% url 'save_document_type' %}">
        {% csrf_token %}
        <div class="mb-3">
          <label for="doc-type-name" class="form-label">Document Type Name</label>
          <input type="text" name="name" id="doc-type-name" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="doc-type-desc" class="form-label">Description</label>
          <textarea name="description" id="doc-type-desc" class="form-control"></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Save Document Type</button>
      </form>
      <h4 class="mt-3">Existing Document Types</h4>
      <ul class="list-group">
        {% for dt in document_types %}
          <li class="list-group-item">{{ dt.name }} - {{ dt.description }}</li>
        {% empty %}
          <li class="list-group-item">No document types available.</li>
        {% endfor %}
      </ul>
    </div> -->
    
    <!-- Tab 3: Placeholder -->
    <div class="tab-pane fade" id="tab3" role="tabpanel">
      <h3 class="mt-3">Tab 3</h3>
      <p>Content for Tab 3 goes here.</p>
    </div>
    
    <!-- Tab 4: Placeholder -->
    <div class="tab-pane fade" id="tab4" role="tabpanel">
      <h3 class="mt-3">Tab 4</h3>
      <p>Content for Tab 4 goes here.</p>
    </div>
  </div>
</div>
</main>

<!-- jQuery for dynamic assignee dropdown behavior -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function(){
    $("#client").change(function(){
        var selectedClient = $(this).val();
        if(selectedClient){
            $("#assignee-container").show();
            // Reset all options
            $("#assignee-select option").show();
            // Hide the selected client from the assignee list
            $("#assignee-select option[value='" + selectedClient + "']").hide();
        } else {
            $("#assignee-container").hide();
        }
    });
});
</script>
{% endblock %}



          <!-- Show Validate button only if a reference number exists and status is not "Raise Query" and user is an assignee -->
          {% if form.reference_number and form.status != "Raise Query" and request.user in form.assignees.all %}
          {% if validation_type == "system" %}
            <!-- For system validation, open modal for validator selection -->
            <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#validateModal">
              Validate
            </button>
          {% elif validation_type == "client" or validation_type == "both" %}
            <!-- For client or both, the client is used automatically -->
            <button type="button" class="btn btn-info" id="clientValidateBtn">
              Validate
            </button>
          {% endif %}
          {% endif %}

          <!-- Modal for System Validation (if validation_type is "system") -->
          <div class="modal fade" id="validateModal" tabindex="-1" aria-labelledby="validateModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <form id="validateForm" method="POST" action="{% url 'validate_form' form.id %}">
                {% csrf_token %}
                <div class="modal-header">
                  <h5 class="modal-title" id="validateModalLabel">Select Validator</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-3">
                    <label for="validator" class="form-label">Validator:</label>
                    <select name="validator" id="validator" class="form-control" required>
                      <option value="">-- Select Validator --</option>
                      {% for user in potential_validators %}
                        <option value="{{ user.id }}">{{ user.username }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <!-- You can add additional instructions or fields here if needed -->
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn btn-primary">Validate</button>
                </div>
              </form>
            </div>
          </div>
          </div>

          document.addEventListener("DOMContentLoaded", function () {
            // For client or both validation, clicking the Validate button auto-updates the status
            $("#clientValidateBtn").click(function(){
                Swal.fire({
                    title: "Are you sure?",
                    text: "Do you want to validate this form? (Client will be used as validator)",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#3085d6",
                    cancelButtonColor: "#d33",
                    confirmButtonText: "Yes, Validate"
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Show processing alert
                        Swal.fire({
                            title: "Processing...",
                            text: "Please wait while we validate the form.",
                            icon: "info",
                            allowOutsideClick: false,
                            showConfirmButton: false,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });
          
                        // Submit AJAX request to validate the form automatically, using the client (form.created_by) as validator
                        $.ajax({
                            url: "{% url 'validate_form' form.id %}",
                            type: "POST",
                            data: {
                                validator: "{{ form.created_by.id }}",  // client is used as validator
                                csrfmiddlewaretoken: "{{ csrf_token }}"
                            },
                            success: function(response) {
                                if(response.success){
                                    Swal.fire({
                                        title: "Success!",
                                        text: "Form validated successfully, and status updated to Closed.",
                                        icon: "success",
                                        timer: 1500,
                                        showConfirmButton: false
                                    }).then(() => {
                                        location.reload();
                                    });
                                } else {
                                    Swal.fire({
                                        title: "Error!",
                                        text: response.error || "Failed to update status.",
                                        icon: "error",
                                        confirmButtonText: "OK"
                                    });
                                }
                            },
                            error: function() {
                                Swal.fire({
                                    title: "Error!",
                                    text: "An error occurred while validating the form.",
                                    icon: "error",
                                    confirmButtonText: "OK"
                                });
                            }
                        });
                    }
                });
            });
          });




          <script>
            $(document).ready(function(){
                $("#client").change(function(){
                    var clientId = $(this).val();
                    var mappedDiv = $("#mappedAssignees");
                    var assigneeDropdown = $("#assignee-select");
            
                    // Clear previous content
                    mappedDiv.empty();
                    assigneeDropdown.empty();
            
                    if(clientId){
                        $("#assignee-container").show();
                        $.ajax({
                            url: "{% url 'get_assignees' %}",
                            data: { client_id: clientId },
                            dataType: "json",
                            success: function(response){
                                // Display mapped assignees
                                if(response.assignees && response.assignees.length > 0){
                                    var listHtml = "<ul class='list-group'>";
                                    $.each(response.assignees, function(index, assignee){
                                        listHtml += "<li class='list-group-item'>" + assignee.username + "</li>";
                                    });
                                    listHtml += "</ul>";
                                    mappedDiv.html(listHtml);
                                } else {
                                    mappedDiv.html("<p class='text-muted'>No mapping for this assignee.</p>");
                                }
            
                                // Populate the assignee dropdown
                                if(response.all_assignees && response.all_assignees.length > 0){
                                    $.each(response.all_assignees, function(index, user){
                                        assigneeDropdown.append("<option value='" + user.id + "'>" + user.username + "</option>");
                                    });
                                }
            
                                // Pre-select validation process
                                if(response.validation_process){
                                    $(".validation-radio").each(function(){
                                        if($(this).val() == response.validation_process){
                                            $(this).prop("checked", true);
                                        }
                                    });
                                }
                            },
                            error: function(){
                                mappedDiv.html("<p class='text-danger'>Error loading data.</p>");
                            }
                        });
                    } else {
                        $("#assignee-container").hide();
                        mappedDiv.html("<p class='text-muted'>Please select a client.</p>");
                    }
                });
            });
            </script>
            